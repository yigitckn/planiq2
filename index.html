<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanIQ - Akıllı Günlük Planlayıcı</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        @keyframes slideUp {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -30px, 0); }
            70% { transform: translate3d(0, -15px, 0); }
            90% { transform: translate3d(0, -4px, 0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
        .animate-slideUp { animation: slideUp 0.5s ease-out; }
        .animate-bounce { animation: bounce 1.5s ease-in-out infinite; }
        .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyARs7TFmAOSq88lTgYSlUJjGoQP_rt9SwA",
            authDomain: "planiq-170ca.firebaseapp.com",
            projectId: "planiq-170ca",
            storageBucket: "planiq-170ca.firebasestorage.app",
            messagingSenderId: "110643251007",
            appId: "1:110643251007:web:28d01c098db5f74280358a",
            measurementId: "G-VZJR3XE0XT"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Helper Functions
        const formatDateKey = (date) => {
            if (!(date instanceof Date) || isNaN(date)) {
                return new Date().toISOString().split('T')[0];
            }
            return date.toISOString().split('T')[0];
        };
        
        const formatFullDate = (date) => {
            if (!(date instanceof Date) || isNaN(date)) {
                date = new Date();
            }
            return new Intl.DateTimeFormat('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' }).format(date);
        };
        
        const formatDisplayDate = (date) => {
            if (!(date instanceof Date) || isNaN(date)) {
                date = new Date();
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);
            
            if (targetDate.getTime() === today.getTime()) return "Bugün";
            if (targetDate.getTime() === tomorrow.getTime()) return "Yarın";
            if (targetDate.getTime() === yesterday.getTime()) return "Dün";
            
            const day = String(targetDate.getDate()).padStart(2, '0');
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
        };
        
        const parseTime = (timeString) => {
            if (!timeString || !timeString.includes(':')) return null;
            const [hours, minutes] = timeString.split(':').map(Number);
            if (isNaN(hours) || isNaN(minutes)) return null;
            return { hours, minutes };
        };
        
        const isTimeLaterOrEqual = (time1, time2) => {
            const t1 = parseTime(time1);
            const t2 = parseTime(time2);
            if (!t1 || !t2) return false;
            if (t1.hours > t2.hours) return true;
            if (t1.hours === t2.hours && t1.minutes >= t2.minutes) return true;
            return false;
        };
        
        const addMinutesToTime = (timeString, minutesToAdd) => {
            const time = parseTime(timeString);
            if (!time) return timeString;
            
            let totalMinutes = time.hours * 60 + time.minutes + minutesToAdd;
            totalMinutes = (totalMinutes + 1440) % 1440;
            
            const newHours = Math.floor(totalMinutes / 60);
            const newMinutes = totalMinutes % 60;
            
            return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
        };
        
        // Splash Screen Component
        const SplashScreen = () => {
            return React.createElement('div', {
                className: "fixed inset-0 bg-gradient-to-br from-purple-600 via-purple-500 to-pink-500 flex items-center justify-center z-50 overflow-hidden"
            }, [
                React.createElement('div', {
                    key: 'bubbles',
                    className: "absolute top-1/4 left-1/4 w-48 h-48 bg-white/10 rounded-full filter blur-3xl animate-pulse"
                }),
                React.createElement('div', {
                    key: 'bubbles2',
                    className: "absolute bottom-1/4 right-1/4 w-32 h-32 bg-white/10 rounded-full filter blur-3xl animate-pulse"
                }),
                React.createElement('div', {
                    key: 'content',
                    className: "text-center animate-fadeIn relative z-10"
                }, [
                    React.createElement('div', {
                        key: 'logo',
                        className: "mb-6 animate-bounce"
                    }, React.createElement('div', {
                        className: "w-32 h-32 bg-white rounded-3xl shadow-2xl flex items-center justify-center mx-auto transform transition-transform duration-500 hover:scale-110"
                    }, React.createElement('div', {
                        className: "w-20 h-20 text-purple-600 animate-pulse"
                    }, '🧠'))),
                    React.createElement('h1', {
                        key: 'title',
                        className: "text-6xl font-bold text-white mb-4 animate-slideUp"
                    }, [
                        'Plan',
                        React.createElement('span', {
                            key: 'iq',
                            className: "text-yellow-300"
                        }, 'IQ')
                    ]),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: "text-white/90 text-xl animate-slideUp"
                    }, 'Akıllı Günlük Planlayıcın')
                ])
            ]);
        };
        
        // DailyPlanCard Component
        const DailyPlanCard = ({ day, userData, selectedDateKey, userId, isDark }) => {
            const [tasks, setTasks] = useState([]);
            const [isLoadingTasks, setIsLoadingTasks] = useState(true);
            const [isAddingTask, setIsAddingTask] = useState(false);
            const [newTask, setNewTask] = useState({ time: '', name: '' });
            const [modalTask, setModalTask] = useState(null);
            const [modalContentStage, setModalContentStage] = useState('initial');
            const [aiSuggestionContent, setAiSuggestionContent] = useState(null);
            
            // Gerçek AI tarif öneri fonksiyonu
            const generateRecipeSuggestions = async (mealType, cuisine, userCuisines) => {
                try {
                    // AI için tarif önerisi
                    const generateAIRecipe = async (prompt) => {
                        try {
                            // Gemini AI API - Google Search ile gerçek tarifler
                            console.log('Gemini AI + Google Search tarif önerileri çalışıyor...');
                            
                            const geminiResponse = await fetch('/.netlify/functions/gemini-proxy', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({ prompt })
                            });

                            if (geminiResponse.ok) {
                                const data = await geminiResponse.json();
                                console.log('Gemini API Response:', data);
                                
                                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                                    const result = data.candidates[0].content.parts[0].text;
                                    console.log('Gemini AI Success:', result);
                                    return result;
                                }
                            } else {
                                console.log('Gemini API Error:', geminiResponse.status, await geminiResponse.text());
                            }
                        } catch (error) {
                            console.log('Gemini AI failed:', error);
                        }

                        // Fallback: Mock AI (API çalışmazsa)
                        console.log('Fallback Mock AI tarif önerileri çalışıyor...');
                        
                        // Öğün tipini çıkar - daha kesin kontrol
                        let mealType = 'kahvaltı'; // varsayılan
                        if (prompt.includes('öğle yemeği') || prompt.includes('öğle')) {
                            mealType = 'öğle yemeği';
                        } else if (prompt.includes('akşam yemeği') || prompt.includes('akşam')) {
                            mealType = 'akşam yemeği';
                        } else if (prompt.includes('kahvaltı')) {
                            mealType = 'kahvaltı';
                        }
                        
                        console.log('Algılanan öğün tipi:', mealType);
                        
                        // Mutfak tipini çıkar
                        const cuisine = prompt.includes('Türk') ? 'Türk' : 
                                      prompt.includes('İtalyan') ? 'İtalyan' : 
                                      prompt.includes('Uzak Doğu') ? 'Uzak Doğu' : 'genel';
                        
                        // Gerçekçi tarif önerileri oluştur - kısa ve öz
                        const mockRecipes = {
                            'kahvaltı': [
                                `Menemen:\nTaze domates, biber ve yumurta ile hazırlanan Türk kahvaltısının vazgeçilmez lezzeti. 15 dakikada hazır.`,
                                `Omlet:\nKlasik yumurta yemeği, taze otlar ve peynirle zenginleştirilmiş. 10 dakikada hazır.`,
                                `Serpme Kahvaltı:\nPeynir, zeytin, domates, salatalık ve reçel ile hazırlanan geleneksel Türk kahvaltısı.`,
                                `Avokado Tost:\nTaze avokado, limon ve tuz ile hazırlanan modern kahvaltı. 5 dakikada hazır.`,
                                `Yulaf Ezmesi:\nSüt ile pişirilen yulaf, taze meyveler ve bal ile tatlandırılmış. 10 dakikada hazır.`
                            ],
                            'öğle yemeği': [
                                `Kebap:\nGeleneksel Türk kebap çeşitleri, taze et ve baharatlarla hazırlanan. 30 dakikada hazır.`,
                                `Mantı:\nHamur içi et ile doldurulmuş, yoğurt sosu ile servis edilen. 45 dakikada hazır.`,
                                `Lahmacun:\nİnce hamur üzerine kıyma, domates ve baharatlarla hazırlanan. 25 dakikada hazır.`,
                                `Çorba:\nSıcak ve besleyici çorba çeşitleri. 20 dakikada hazır.`,
                                `Salata:\nTaze yeşillikler, sebzeler ve protein kaynakları ile hazırlanan. 15 dakikada hazır.`,
                                `Sandviç:\nEkmek arası taze malzemelerle hazırlanan pratik yemek. 10 dakikada hazır.`
                            ],
                            'akşam yemeği': [
                                `Kuzu Tandır:\nUzun süre pişirilen kuzu eti, geleneksel Türk mutfağının özel lezzeti. 2 saatte hazır.`,
                                `Balık:\nTaze balık çeşitleri, zeytinyağı ve limon ile hazırlanan. 30 dakikada hazır.`,
                                `Pasta:\nMakarna çeşitleri, çeşitli soslarla hazırlanan doyurucu yemek. 25 dakikada hazır.`,
                                `Et Yemeği:\nTavuk, dana veya kuzu eti ile hazırlanan protein açısından zengin yemek. 45 dakikada hazır.`,
                                `Sebze Yemeği:\nTaze sebzelerle hazırlanan hafif ve sağlıklı yemek. 20 dakikada hazır.`,
                                `Pilav:\nPirinç pilavı, et suyu ile hazırlanan geleneksel yan yemek. 30 dakikada hazır.`
                            ]
                        };
                        
                        // Rastgele 3-4 tarif seç
                        const recipes = mockRecipes[mealType] || mockRecipes['kahvaltı'];
                        const selectedRecipes = recipes.sort(() => 0.5 - Math.random()).slice(0, 3);
                        
                        // AI yanıtı formatında döndür
                        return selectedRecipes.join('\n\n');
                    };
                    
                    // AI için prompt oluştur
                    const cuisineText = userCuisines && userCuisines.length > 0 
                        ? `Kullanıcının sevdiği mutfaklar: ${userCuisines.join(', ')}` 
                        : 'Genel mutfak';
                    
                    const mealTypeTurkish = {
                        'kahvaltı': 'kahvaltı',
                        'öğle yemeği': 'öğle yemeği', 
                        'akşam yemeği': 'akşam yemeği'
                    };
                    
                    const currentMealType = mealTypeTurkish[mealType] || mealType;
                    
                    const aiPrompt = `${currentMealType} için ${cuisineText} tarifleri öner. 
                    Lütfen 2-3 farklı lezzetli tarif öner, her birinin adını ve detaylı açıklamasını ver. 
                    Format: 
                    "Tarif Adı:
                    Açıklama: [Tarifin malzemelerini, hazırlanışını, özelliklerini detaylıca anlat]"
                    
                    Örnek:
                    "Menemen:
                    Açıklama: Domates, biber ve yumurta ile hazırlanan, Türk kahvaltılarının vazgeçilmez lezzeti. Taze domates ve biberlerin kavrulmasıyla hazırlanan bu pratik yemek, doyurucu ve besleyicidir."
                    
                    Sadece tarif isimlerini ve açıklamalarını ver, başka açıklama yapma.`;
                    
                    // AI'dan tarif al
                    const aiResponse = await generateAIRecipe(aiPrompt);
                    
                    if (aiResponse) {
                        // AI yanıtını parse et - tarif adı ve açıklama formatında
                        const lines = aiResponse.split('\n').filter(line => line.trim());
                        const suggestions = [];
                        let currentRecipe = null;
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            
                            // Tarif adı (Açıklama: ile bitmeyen satırlar)
                            if (line && !line.startsWith('Açıklama:') && !line.match(/^\d+\./)) {
                                if (currentRecipe) {
                                    suggestions.push(currentRecipe);
                                }
                                currentRecipe = {
                                    name: line.replace(/^[-•*]\s*/, ''),
                                    description: ''
                                };
                            }
                            // Açıklama
                            else if (line.startsWith('Açıklama:') && currentRecipe) {
                                currentRecipe.description = line.replace('Açıklama:', '').trim();
                            }
                        }
                        
                        // Son tarifi ekle
                        if (currentRecipe) {
                            suggestions.push(currentRecipe);
                        }
                        
                        if (suggestions.length > 0) {
                            return suggestions.map(s => `${s.name}:\n${s.description}`);
                        }
                    }
                    
                    // Fallback: Statik tarifler
                    const recipes = mockRecipes[mealType] || mockRecipes['kahvaltı'];
const selectedRecipes = recipes.sort(() => 0.5 - Math.random()).slice(0, 3);

// AI yanıtı formatında döndür
return selectedRecipes.join('\n\n');
                
                } catch (error) {
                    console.error('Tarif öneri hatası:', error);
                    // Hata durumunda genel öneriler
                    return ['Omlet', 'Menemen', 'Yulaf Ezmesi']; 
                }
            };
            
            // Gerçek AI restoran öneri fonksiyonu
            const generateRestaurantSuggestions = async (mealType, city, userCuisines) => {
                console.log('generateRestaurantSuggestions çağrıldı:', { mealType, city, userCuisines });
                try {
                    // OpenAI API entegrasyonu için
                    const generateAIRecommendations = async (prompt) => {
                        try {
                            // Netlify Functions proxy üzerinden Gemini AI çağrısı
                            const geminiResponse = await fetch('/.netlify/functions/gemini-proxy', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ prompt })
                            });

                            if (geminiResponse.ok) {
                                const data = await geminiResponse.json();
                                if (data.success) {
                                    return data.result;
                                } else if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                                    return data.candidates[0].content.parts[0].text;
                                }
                            } else {
                                throw new Error('Gemini API Error: ' + geminiResponse.status);
                            }
                        } catch(e) {
                            console.error('Gemini AI Restaurant Hatası:', e);
                            return null;
                        }
                    };
                    
                    // OpenAI API'yi dene (CORS proxy ile)
                    console.log('OpenAI API + CORS proxy çalışıyor...');
                    
                    const openaiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('openai_api_key') || 'sk-proj-placeholder'}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'Sen bir restoran öneri uzmanısın. Kullanıcının şehrine özel gerçek restoran isimleri ve açıklamaları ver.'
                                },
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            max_tokens: 500,
                            temperature: 0.7
                        })
                    });

                    if (geminiResponse.ok) {
                        const data = await geminiResponse.json();
                        console.log('Gemini API Response:', data);
                        
                        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                            const result = data.candidates[0].content.parts[0].text;
                            console.log('Gemini AI Success:', result);
                            return result;
                        }
                    } else {
                        console.log('Gemini API Error:', geminiResponse.status, await geminiResponse.text());
                    }
                } catch (error) {
                    console.log('Gemini AI failed:', error);
                }

                // Fallback: Güçlü Mock AI (API çalışmazsa)
                console.log('Fallback Mock AI çalışıyor...');
                
                const locationMatch = prompt.match(/(\w+)\s+şehrinde/);
                const city = locationMatch ? locationMatch[1] : 'İstanbul';
                
                let mealType = 'kahvaltı';
                if (prompt.includes('öğle yemeği') || prompt.includes('öğle')) {
                    mealType = 'öğle yemeği';
                } else if (prompt.includes('akşam yemeği') || prompt.includes('akşam')) {
                    mealType = 'akşam yemeği';
                } else if (prompt.includes('kahvaltı')) {
                    mealType = 'kahvaltı';
                }
                
                // Akıllı Mock AI - Kullanıcının şehrine göre özel öneriler
                const generateCitySpecificRestaurants = (city, mealType) => {
                    const cityLower = city.toLowerCase();
                    
                    // Şehir bazlı özel restoran isimleri
                    const cityRestaurants = {
                        'istanbul': {
                            'kahvaltı': [
                                `Van Kahvaltı Evi:\nBeşiktaş'ta geleneksel Türk kahvaltısının en güzel örneklerini sunan popüler mekan.`,
                                `Çakır Kahvaltı:\nŞişli'de serpme kahvaltı geleneğini yaşatan, doğal ürünlerle hazırlanan lezzetli mekan.`,
                                `Mado Kahvaltı:\nKadıköy'de modern kahvaltı seçenekleri sunan, geniş menü çeşitliliği olan popüler mekan.`,
                                `Bebek Kahvaltı:\nBebek'te deniz manzaralı kahvaltı deneyimi sunan şık mekan.`,
                                `Karaköy Güllüoğlu:\nKaraköy'de geleneksel Türk tatlıları ve kahvaltı sunan ünlü mekan.`
                            ],
                            'öğle yemeği': [
                                `Hacı Abdullah:\nBeyoğlu'nda geleneksel Türk mutfağı sunan, özellikle kebap çeşitleriyle ünlü popüler mekan.`,
                                `Çiya Sofrası:\nKadıköy'de Anadolu mutfak kültürünü yansıtan, geleneksel yemekleri modern sunumla birleştiren restoran.`,
                                `Köfteci Ramiz:\nFatih'te köfte ve ızgara çeşitleriyle ünlü, hızlı servisi olan popüler mekan.`,
                                `Zeytin Dalı:\nEtiler'de Akdeniz mutfağı sunan şık restoran.`,
                                `Asmalı Mescit:\nBeyoğlu'nda geleneksel Türk mutfağı sunan tarihi mekan.`
                            ],
                            'akşam yemeği': [
                                `Mikla:\nBeyoğlu'nda fine dining deneyimi sunan, şık atmosferi ve özel akşam menüleriyle ünlü romantik restoran.`,
                                `Neolokal:\nBeyoğlu'nda modern Türk mutfağı sunan, akşam yemeği için özel menüleri olan şık mekan.`,
                                `Sunset Grill & Bar:\nEtiler'de manzaralı, akşam yemeği için mükemmel atmosfer sunan lüks restoran.`,
                                `Lokanta 1741:\nBeyoğlu'nda geleneksel Osmanlı mutfağı sunan şık restoran.`,
                                `Türk Fatih Tutak:\nŞişli'de modern Türk mutfağı sunan Michelin yıldızlı restoran.`
                            ]
                        },
                        'ankara': {
                            'kahvaltı': [
                                `Kızılay Kahvaltı Evi:\nKızılay'da geleneksel Türk kahvaltısı sunan, sıcak atmosferi olan popüler mekan.`,
                                `Çankaya Kahvaltı:\nÇankaya'da modern kahvaltı seçenekleri sunan, geniş menü çeşitliliği olan mekan.`,
                                `Ulus Kahvaltı Salonu:\nUlus'ta serpme kahvaltı geleneğini yaşatan, doğal ürünlerle hazırlanan lezzetli mekan.`,
                                `Bahçelievler Kahvaltı:\nBahçelievler'de taze malzemelerle hazırlanan kahvaltı sunan mekan.`,
                                `Tunalı Kahvaltı:\nTunalı'da çağdaş kahvaltı seçenekleri sunan şık mekan.`
                            ],
                            'öğle yemeği': [
                                `Ankara Kebap Evi:\nUlus'ta geleneksel Türk mutfağı sunan, özellikle kebap çeşitleriyle ünlü popüler mekan.`,
                                `Çankaya Sofrası:\nÇankaya'da Anadolu mutfak kültürünü yansıtan, geleneksel yemekleri modern sunumla birleştiren restoran.`,
                                `Kızılay Lokantası:\nKızılay'da ev yemekleri ve geleneksel lezzetler sunan, hızlı servisi olan popüler mekan.`,
                                `Bahçelievler Kebap:\nBahçelievler'de kebap çeşitleri sunan popüler restoran.`,
                                `Tunalı Modern:\nTunalı'da çağdaş lezzetler sunan şık mekan.`
                            ],
                            'akşam yemeği': [
                                `Ankara Fine Dining:\nÇankaya'da özel akşam menüleri ve şık atmosferi olan romantik restoran.`,
                                `Çankaya Modern:\nÇankaya'da çağdaş lezzetler ve yenilikçi sunumlar sunan şık mekan.`,
                                `Ulus Geleneksel:\nUlus'ta yerel mutfağın en güzel örneklerini sunan otantik mekan.`,
                                `Kızılay Akşam:\nKızılay'da romantik atmosferi olan şık akşam mekanı.`,
                                `Tunalı Akşam:\nTunalı'da çağdaş lezzetler sunan şık akşam mekanı.`
                            ]
                        },
                        'izmir': {
                            'kahvaltı': [
                                `Konak Kahvaltı Evi:\n${city} bölgesinde Ege mutfağının lezzetlerini sunan, deniz manzaralı popüler mekan.`,
                                `Alsancak Kahvaltı:\n${city} bölgesinde modern kahvaltı seçenekleri sunan, geniş menü çeşitliliği olan mekan.`,
                                `Bornova Kahvaltı Salonu:\n${city} bölgesinde serpme kahvaltı geleneğini yaşatan, doğal ürünlerle hazırlanan lezzetli mekan.`
                            ],
                            'öğle yemeği': [
                                `İzmir Kebap Evi:\n${city} bölgesinde geleneksel Türk mutfağı sunan, özellikle kebap çeşitleriyle ünlü popüler mekan.`,
                                `Ege Sofrası:\n${city} bölgesinde Ege mutfak kültürünü yansıtan, geleneksel yemekleri modern sunumla birleştiren restoran.`,
                                `Konak Lokantası:\n${city} bölgesinde ev yemekleri ve geleneksel lezzetler sunan, hızlı servisi olan popüler mekan.`
                            ],
                            'akşam yemeği': [
                                `İzmir Fine Dining:\n${city} bölgesinde özel akşam menüleri ve şık atmosferi olan romantik restoran.`,
                                `Alsancak Modern:\n${city} bölgesinde çağdaş lezzetler ve yenilikçi sunumlar sunan şık mekan.`,
                                `Bornova Geleneksel:\n${city} bölgesinde yerel mutfağın en güzel örneklerini sunan otantik mekan.`
                            ]
                        },
                        'kağıthane': {
                            'kahvaltı': [
                                `Kağıthane Kahvaltı Evi:\n${city} bölgesinde taze malzemelerle hazırlanan geleneksel kahvaltı lezzetleri sunan, sıcak ve samimi atmosferi olan popüler mekan.`,
                                `Modern Kafe:\n${city} bölgesinde uluslararası kahvaltı seçenekleri ve kaliteli kahve çeşitleri sunan, çağdaş tasarımı olan popüler mekan.`,
                                `Geleneksel Restoran:\n${city} bölgesinde yerel mutfağın en güzel örneklerini sunan, otantik atmosferi olan popüler mekan.`
                            ],
                            'öğle yemeği': [
                                `Kağıthane Kebap Evi:\n${city} bölgesinde geleneksel Türk mutfağı sunan, özellikle kebap çeşitleriyle ünlü popüler mekan.`,
                                `Hızlı Servis:\n${city} bölgesinde pratik öğle yemeği seçenekleri sunan, hızlı servisi olan popüler mekan.`,
                                `Ev Yemekleri:\n${city} bölgesinde sıcak yemek seçenekleri sunan, ev yemeği tadında lezzetler.`
                            ],
                            'akşam yemeği': [
                                `Kağıthane Fine Dining:\n${city} bölgesinde özel akşam menüleri ve şık atmosferi olan romantik restoran.`,
                                `Modern Mutfak:\n${city} bölgesinde çağdaş lezzetler ve yenilikçi sunumlar sunan şık mekan.`,
                                `Geleneksel Restoran:\n${city} bölgesinde yerel mutfağın en güzel örneklerini sunan otantik mekan.`
                            ]
                        }
                    };
                    
                    // Şehir algılama
                    let cityKey = 'istanbul'; // varsayılan
                    if (cityLower.includes('ankara') || cityLower.includes('çankaya') || cityLower.includes('kızılay')) {
                        cityKey = 'ankara';
                    } else if (cityLower.includes('izmir') || cityLower.includes('konak') || cityLower.includes('alsancak')) {
                        cityKey = 'izmir';
                    } else if (cityLower.includes('kağıthane') || cityLower.includes('kağıthane')) {
                        cityKey = 'kağıthane';
                    } else if (cityLower.includes('sarıyer') || cityLower.includes('sariyer')) {
                        cityKey = 'sarıyer';
                    } else if (cityLower.includes('istanbul') || cityLower.includes('beşiktaş') || cityLower.includes('şişli') || cityLower.includes('kadıköy')) {
                        cityKey = 'istanbul';
                    }
                    
                    return cityRestaurants[cityKey]?.[mealType] || cityRestaurants['istanbul']['kahvaltı'];
                };
                
                const responses = generateCitySpecificRestaurants(city, mealType);
                const selectedResponses = responses.sort(() => 0.5 - Math.random()).slice(0, 3);
                return selectedResponses;
            };
            
            // Kullanıcının onboarding'de girdiği gerçek lokasyonu al
            const userLocation = userData?.location || city;
            const userCity = userLocation.split(',')[0].trim(); // Sadece şehir adını al
            
            console.log('Kullanıcının şehri:', userCity);
            console.log('userData:', userData);
            
            // AI için prompt oluştur - gerçek lokasyon bazlı
            const cuisineText = userCuisines && userCuisines.length > 0 
                ? `Kullanıcının sevdiği mutfaklar: ${userCuisines.join(', ')}` 
                : 'Mutfak tercihi belirtilmemiş';
            
            const mealTypeTurkish = {
                'kahvaltı': 'kahvaltı',
                'öğle yemeği': 'öğle yemeği',
                'akşam yemeği': 'akşam yemeği'
            };
            
            const currentMealType = mealTypeTurkish[mealType] || mealType;
            
            const aiPrompt = `Kullanıcı ${userCity} şehrinde yaşıyor. ${userCity} şehrinde ${currentMealType} için gerçek restoran önerileri istiyorum. ${cuisineText}. 
            
            Lütfen ${userCity} şehrinde gerçekten var olan 3-4 farklı restoran öner, her birinin adını ve detaylı açıklamasını ver. 
            
            ÖNEMLİ: 
            - Sadece ${userCity} şehrindeki GERÇEK restoran isimlerini ver
            - Her restoran için kısa ama öz açıklama yaz
            - Restoranın özelliklerini, mutfağını, atmosferini belirt
            - Format: "Restoran Adı:\nAçıklama: [Detaylı açıklama]"
            
            Örnek format:
            "Pişi Breakfast & Burger:
            Açıklama: Beşiktaş Kahvaltıcılar Sokağı'nda pişi bazlı kahvaltılar sunan popüler mekan."
            
            Sadece ${userCity} şehrindeki gerçek restoranları ver, başka açıklama yapma.`;
            
            // AI'dan öneri al
            const aiResponse = await generateAIRecommendations(aiPrompt);
            
            if (aiResponse && typeof aiResponse === 'string') {
                // AI yanıtını parse et - restoran adı ve açıklama formatında
                const lines = aiResponse.split('\n').filter(line => line.trim());
                const suggestions = [];
                let currentRestaurant = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Restoran adı (Açıklama: ile bitmeyen satırlar)
                    if (line && !line.startsWith('Açıklama:') && !line.match(/^\d+\./)) {
                        if (currentRestaurant) {
                            suggestions.push(currentRestaurant);
                        }
                        currentRestaurant = {
                            name: line.replace(/^[-•*]\s*/, ''),
                            description: ''
                        };
                    }
                    // Açıklama
                    else if (line.startsWith('Açıklama:') && currentRestaurant) {
                        currentRestaurant.description = line.replace('Açıklama:', '').trim();
                    }
                }
                
                // Son restoranı ekle
                if (currentRestaurant) {
                    suggestions.push(currentRestaurant);
                }
                
                if (suggestions.length > 0) {
                    return suggestions.map(s => `${s.name}:\n${s.description}`);
                }
            }
            
            // Fallback: Statik veriler (API çalışmazsa) - Kullanıcının lokasyonuna göre
            const fallbackRestaurants = {
                'sofya': {
                    kahvaltı: {
                        'Türk Mutfağı': [
                            'Sultan Sofya:\nGeleneksel Türk kahvaltısının en güzel örneklerini sunan, sıcak ve samimi atmosferi olan popüler bir mekandır.',
                            'Balkan Evi:\nKarışık kahvaltı tabağı ve Balkan mutfağının lezzetlerini sunan, geniş menü seçenekleri olan popüler bir mekandır.',
                            'İstanbul Kafe:\nSerpme kahvaltı ve Türk çayı geleneğini yaşatan, huzurlu bir ortama sahip popüler bir mekandır.'
                        ],
                        'Bulgar': [
                            'Mekitsa & Kafe:\nGeleneksel Bulgar kahvaltısı ve taze mekitsa çeşitleri sunan, yerel lezzetleri keşfetmek için ideal bir mekandır.',
                            'Banitsa House:\nTaze banitsa ve çay eşliğinde geleneksel Bulgar kahvaltısı sunan, sıcak atmosferi olan popüler bir mekandır.',
                            'Sofia Central:\nModern Bulgar kahvaltısı ve çağdaş sunumlarla dikkat çeken, şehir merkezinde yer alan popüler bir mekandır.'
                        ],
                        'genel': [
                            'Costa Coffee:\nUluslararası kahvaltı seçenekleri ve kaliteli kahve çeşitleri sunan, modern atmosferi olan popüler bir mekandır.',
                            'Starbucks:\nKlasik kahvaltı seçenekleri ve özel kahve çeşitleri sunan, rahat çalışma ortamı olan popüler bir mekandır.',
                            'Cafe Central:\nAvrupa tarzı kahvaltı ve pastane ürünleri sunan, şık dekorasyonu olan popüler bir mekandır.'
                        ]
                    },
                    'öğle yemeği': {
                        'Türk Mutfağı': [
                            'Kebapçı İskender:\nGeleneksel Türk mutfağının en güzel örneklerini sunan, özellikle kebap çeşitleriyle ünlü popüler bir mekandır.',
                            'Sultan Sofya:\nTürk yemekleri ve geleneksel lezzetleri sunan, sıcak atmosferi olan popüler bir mekandır.',
                            'Balkan Evi:\nKarışık Balkan mutfağı ve çeşitli lezzetler sunan, geniş menü seçenekleri olan popüler bir mekandır.'
                        ],
                        'Bulgar': [
                            'Shtastliveca:\nGeleneksel Bulgar mutfağının en güzel örneklerini sunan, yerel lezzetleri keşfetmek için ideal bir mekandır.',
                            'Made in Home:\nModern Bulgar yemekleri ve çağdaş sunumlarla dikkat çeken, şık dekorasyonu olan popüler bir mekandır.',
                            'Pod Lipite:\nKlasik Bulgar restoranı ve geleneksel lezzetleri sunan, sıcak atmosferi olan popüler bir mekandır.'
                        ],
                        'genel': [
                            'Happy Bar & Grill:\nHızlı yemek ve çeşitli lezzetler sunan, modern atmosferi olan popüler bir mekandır.',
                            'McDonald\'s:\nFast food ve hızlı servis sunan, uluslararası standartlarda popüler bir mekandır.',
                            'Subway:\nSağlıklı sandviçler ve taze malzemelerle hazırlanan yemekler sunan popüler bir mekandır.'
                        ]
                    },
                    'akşam yemeği': {
                        'Türk Mutfağı': [
                            'Kebapçı İskender:\nAkşam yemeği için özel menüleri ve geleneksel Türk mutfağının en güzel örneklerini sunan popüler bir mekandır.',
                            'Sultan Sofya:\nTürk mutfağı ve akşam yemeği lezzetleri sunan, romantik atmosferi olan popüler bir mekandır.',
                            'Balkan Evi:\nAkşam menüsü ve Balkan mutfağının çeşitli lezzetlerini sunan, sıcak atmosferi olan popüler bir mekandır.'
                        ],
                        'Bulgar': [
                            'Shtastliveca:\nGeleneksel akşam yemeği ve Bulgar mutfağının en güzel örneklerini sunan popüler bir mekandır.',
                            'Made in Home:\nModern akşam menüsü ve çağdaş Bulgar yemekleri sunan, şık dekorasyonu olan popüler bir mekandır.',
                            'Pod Lipite:\nKlasik akşam yemeği ve geleneksel Bulgar lezzetleri sunan, sıcak atmosferi olan popüler bir mekandır.'
                        ],
                        'genel': [
                            'Happy Bar & Grill:\nAkşam yemeği ve çeşitli lezzetler sunan, canlı atmosferi olan popüler bir mekandır.',
                            'Pizza Palace:\nPizza ve pasta çeşitleri sunan, aile ortamı olan popüler bir mekandır.',
                            'Sushi Bar:\nJapon mutfağı ve sushi çeşitleri sunan, şık dekorasyonu olan popüler bir mekandır.'
                        ]
                    }
                },
                'şişli': {
                    kahvaltı: {
                        'Türk Mutfağı': [
                            'Van Kahvaltı Evi - Nişantaşı',
                            'Çakır Kahvaltı - Harbiye',
                            'Bebek Kahvaltı - Etiler',
                            'Serpme Kahvaltı - Maçka'
                        ],
                        'İtalyan': [
                            'Caffe Nero - City\'s Nişantaşı',
                            'Starbucks - Akmerkez',
                            'Caffe Vergnano - Teşvikiye'
                        ],
                        'Uzak Doğu': [
                            'SushiCo - City\'s Nişantaşı',
                            'Wagamama - Akmerkez',
                            'Zuma - Etiler'
                        ],
                        'Meksika': [
                            'Taco Bell - City\'s Nişantaşı',
                            'Chipotle - Akmerkez'
                        ],
                        'Hint': [
                            'Bombay Palace - Harbiye',
                            'Masala - Nişantaşı'
                        ],
                        'genel': [
                            'Kahve Dünyası - Harbiye',
                            'Simit Sarayı - Teşvikiye',
                            'Cafe Nero - Maçka'
                        ]
                    },
                    'öğle yemeği': {
                        'Türk Mutfağı': [
                            'Hacı Abdullah - Harbiye',
                            'Kebapçı İskender - Nişantaşı',
                            'Çiya Sofrası - Etiler',
                            'Lokma - Maçka'
                        ],
                        'İtalyan': [
                            'Pizza Express - City\'s Nişantaşı',
                            'Vapiano - Akmerkez',
                            'Rossopomodoro - Teşvikiye'
                        ],
                        'Uzak Doğu': [
                            'SushiCo - City\'s Nişantaşı',
                            'Wagamama - Akmerkez',
                            'Zuma - Etiler'
                        ],
                        'Meksika': [
                            'Taco Bell - City\'s Nişantaşı',
                            'Chipotle - Akmerkez'
                        ],
                        'Hint': [
                            'Bombay Palace - Harbiye',
                            'Masala - Nişantaşı'
                        ],
                        'genel': [
                            'Burger King - Harbiye',
                            'McDonald\'s - Teşvikiye',
                            'Subway - Maçka'
                        ]
                    },
                    'akşam yemeği': {
                        'Türk Mutfağı': [
                            'Hacı Abdullah - Harbiye',
                            'Kebapçı İskender - Nişantaşı',
                            'Çiya Sofrası - Etiler',
                            'Lokma - Maçka'
                        ],
                        'İtalyan': [
                            'Pizza Express - City\'s Nişantaşı',
                            'Vapiano - Akmerkez',
                            'Rossopomodoro - Teşvikiye'
                        ],
                        'Uzak Doğu': [
                            'SushiCo - City\'s Nişantaşı',
                            'Wagamama - Akmerkez',
                            'Zuma - Etiler'
                        ],
                        'Meksika': [
                            'Taco Bell - City\'s Nişantaşı',
                            'Chipotle - Akmerkez'
                        ],
                        'Hint': [
                            'Bombay Palace - Harbiye',
                            'Masala - Nişantaşı'
                        ],
                        'genel': [
                            'Burger King - Harbiye',
                            'McDonald\'s - Teşvikiye',
                            'Subway - Maçka'
                        ]
                    }
                },
                'kadıköy': {
                    kahvaltı: {
                        'Türk Mutfağı': [
                            'Çiya Sofrası - Kadıköy',
                            'Van Kahvaltı Evi - Moda',
                            'Bebek Kahvaltı - Fenerbahçe'
                        ],
                        'İtalyan': [
                            'Caffe Nero - Kadıköy',
                            'Starbucks - Moda',
                            'Caffe Vergnano - Fenerbahçe'
                        ],
                        'Uzak Doğu': [
                            'SushiCo - Kadıköy',
                            'Wagamama - Moda',
                            'Zuma - Fenerbahçe'
                        ],
                        'genel': [
                            'Kahve Dünyası - Kadıköy',
                            'Simit Sarayı - Moda',
                            'Cafe Nero - Fenerbahçe'
                        ]
                    },
                    'öğle yemeği': {
                        'Türk Mutfağı': [
                            'Hacı Abdullah - Kadıköy',
                            'Kebapçı İskender - Moda',
                            'Çiya Sofrası - Fenerbahçe'
                        ],
                        'İtalyan': [
                            'Pizza Express - Kadıköy',
                            'Vapiano - Moda',
                            'Rossopomodoro - Fenerbahçe'
                        ],
                        'genel': [
                            'Burger King - Kadıköy',
                            'McDonald\'s - Moda',
                            'Subway - Fenerbahçe'
                        ]
                    },
                    'akşam yemeği': {
                        'Türk Mutfağı': [
                            'Hacı Abdullah - Kadıköy',
                            'Kebapçı İskender - Moda',
                            'Çiya Sofrası - Fenerbahçe'
                        ],
                        'İtalyan': [
                            'Pizza Express - Kadıköy',
                            'Vapiano - Moda',
                            'Rossopomodoro - Fenerbahçe'
                        ],
                        'genel': [
                            'Burger King - Kadıköy',
                            'McDonald\'s - Moda',
                            'Subway - Fenerbahçe'
                        ]
                    }
                },
                'beşiktaş': {
                    kahvaltı: {
                        'Türk Mutfağı': [
                            'Van Kahvaltı Evi - Beşiktaş',
                            'Çakır Kahvaltı - Ortaköy',
                            'Bebek Kahvaltı - Bebek'
                        ],
                        'İtalyan': [
                            'Caffe Nero - Beşiktaş',
                            'Starbucks - Ortaköy',
                            'Caffe Vergnano - Bebek'
                        ],
                        'genel': [
                            'Kahve Dünyası - Beşiktaş',
                            'Simit Sarayı - Ortaköy',
                            'Cafe Nero - Bebek'
                        ]
                    },
                    'öğle yemeği': {
                        'Türk Mutfağı': [
                            'Hacı Abdullah - Beşiktaş',
                            'Kebapçı İskender - Ortaköy',
                            'Çiya Sofrası - Bebek'
                        ],
                        'genel': [
                            'Burger King - Beşiktaş',
                            'McDonald\'s - Ortaköy',
                            'Subway - Bebek'
                        ]
                    },
                    'akşam yemeği': {
                        'Türk Mutfağı': [
                            'Hacı Abdullah - Beşiktaş',
                            'Kebapçı İskender - Ortaköy',
                            'Çiya Sofrası - Bebek'
                        ],
                        'genel': [
                            'Burger King - Beşiktaş',
                            'McDonald\'s - Ortaköy',
                            'Subway - Bebek'
                        ]
                    }
                },
                'genel': {
                    kahvaltı: {
                        'genel': [
                            `Kahvaltı Evi:\n${userCity} şehrinde taze malzemelerle hazırlanan geleneksel kahvaltı lezzetleri sunan, sıcak ve samimi atmosferi olan popüler bir mekandır.`,
                            `Modern Kafe:\n${userCity} şehrinde uluslararası kahvaltı seçenekleri ve kaliteli kahve çeşitleri sunan, çağdaş tasarımı olan popüler bir mekandır.`,
                            `Geleneksel Restoran:\n${userCity} şehrinde yerel mutfağın en güzel örneklerini sunan, otantik atmosferi olan popüler bir mekandır.`
                        ]
                    },
                    'öğle yemeği': {
                        'genel': [
                            `Yerel Lokanta:\n${userCity} şehrinde hızlı servis ve ev yemekleri sunan, uygun fiyatlı popüler bir mekandır.`,
                            `Modern Restoran:\n${userCity} şehrinde sağlıklı seçenekler ve çağdaş lezzetler sunan, şık dekorasyonu olan popüler bir mekandır.`,
                            `Aile Restoranı:\n${userCity} şehrinde ev yapımı yemekler ve geniş menü seçenekleri sunan, sıcak atmosferi olan popüler bir mekandır.`
                        ]
                    },
                    'akşam yemeği': {
                        'genel': [
                            `Fine Dining Restoran:\n${userCity} şehrinde özel akşam yemeği menüleri ve şık sunumlarıyla dikkat çeken, romantik atmosferi olan popüler bir mekandır.`,
                            `Geleneksel Restoran:\n${userCity} şehrinde yerel mutfağın en güzel örneklerini sunan, otantik atmosferi olan popüler bir mekandır.`,
                            `Modern Restoran:\n${userCity} şehrinde çağdaş lezzetler ve yenilikçi mutfak teknikleriyle hazırlanan yemekler sunan popüler bir mekandır.`
                        ]
                    }
                }
            };
            
            // Şehir kontrolü ve öneri seçimi
            const cityLower = city.toLowerCase();
            let cityKey = 'genel'; // varsayılan
            
            if (cityLower.includes('sofya') || cityLower.includes('sofia') || cityLower.includes('bulgaristan') || cityLower.includes('bulgaria')) {
                cityKey = 'sofya';
            } else if (cityLower.includes('şişli') || cityLower.includes('nişantaşı') || cityLower.includes('harbiye') || cityLower.includes('teşvikiye') || cityLower.includes('maçka')) {
                cityKey = 'şişli';
            } else if (cityLower.includes('kadıköy') || cityLower.includes('moda') || cityLower.includes('fenerbahçe')) {
                cityKey = 'kadıköy';
            } else if (cityLower.includes('beşiktaş') || cityLower.includes('ortaköy') || cityLower.includes('bebek')) {
                cityKey = 'beşiktaş';
            } else {
                // Bilinmeyen şehir için genel öneriler
                cityKey = 'genel';
            }
            
            const cityRestaurants = fallbackRestaurants[cityKey] || fallbackRestaurants['genel'];
            const mealRestaurants = cityRestaurants[mealType] || cityRestaurants.kahvaltı;
            
            // Kullanıcının tercih ettiği mutfaklara göre öneri seç
            let suggestions = [];
            
            if (userCuisines && userCuisines.length > 0) {
                // Kullanıcının tercih ettiği mutfaklardan öneri seç
                for (const cuisine of userCuisines) {
                    if (mealRestaurants[cuisine]) {
                        suggestions = suggestions.concat(mealRestaurants[cuisine].slice(0, 2));
                    }
                }
                
                // Eğer yeterli öneri yoksa genel kategoriden ekle
                if (suggestions.length < 3) {
                    suggestions = suggestions.concat(mealRestaurants.genel.slice(0, 3 - suggestions.length));
                }
            } else {
                // Tercih yoksa genel kategoriden seç
                suggestions = mealRestaurants.genel.slice(0, 3);
            }
            
            // Benzersiz öneriler döndür
            const finalSuggestions = [...new Set(suggestions)].slice(0, 4);
            console.log('Final restoran önerileri:', finalSuggestions);
            return finalSuggestions;
            
        } catch (error) {
            console.error('Restoran öneri hatası:', error);
            // Hata durumunda genel öneriler
            return [
                `${city} bölgesinde Popüler Restoran - Yerel Lezzetler`,
                `${city} bölgesinde Geleneksel Mutfak - Klasik Yemekler`,
                `${city} bölgesinde Modern Kafe - Çağdaş Seçenekler`,
                `${city} bölgesinde Aile Restoranı - Sıcak Ortam`
            ];
        }
    };
            
            // Generate AI tasks based on user data
            const generateAITasks = (userData, dateKey) => {
                if (!userData) return [];
                
                const targetDate = new Date(dateKey + 'T00:00:00');
                const todayName = targetDate.toLocaleString('tr-TR', { weekday: 'long' });
                const isWeekend = todayName === 'Cumartesi' || todayName === 'Pazar';
                
                let generatedTasks = [];
                
                // Yemek görevleri
                if (userData.breakfastTime) {
                    const suggestionType = userData.breakfastPreference || 'home';
                    let suggestionDetail = suggestionType === 'home' 
                        ? 'PlanIQ, kahvaltını evde yapacağını biliyor. Güne enerjik başlamak için omlet, menemen veya sağlıklı bir yulaf ezmesi deneyebilirsin!'
                        : `PlanIQ, kahvaltını dışarıda yapacağını biliyor. ${userData.city || 'Yakınlarındaki'} bölgedeki popüler bir pastaneden poğaça/börek alabilir veya güzel bir serpme kahvaltı mekanını deneyebilirsin.`;
                    
                    generatedTasks.push({
                        id: `ai_breakfast_${dateKey}`,
                        time: userData.breakfastTime,
                        name: "Kahvaltı",
                        status: "Planlandı",
                        isAISuggestion: true,
                        suggestionDetail: suggestionDetail,
                        suggestionType: suggestionType
                    });
                }
                
                if (userData.lunchTime) {
                    const suggestionType = userData.lunchPreference || 'home';
                    let suggestionDetail = suggestionType === 'home'
                        ? 'Öğle yemeği için evdesin! Hızlı bir sandviç, pratik bir salata veya dünden kalan lezzetli bir yemeği ısıtabilirsin.'
                        : `Öğle yemeği dışarıda! ${userData.city || 'Yakınlarındaki'} bölgedeki bir esnaf lokantası, kafe veya sevdiğin bir restorana ne dersin?`;
                    
                    generatedTasks.push({
                        id: `ai_lunch_${dateKey}`,
                        time: userData.lunchTime,
                        name: "Öğle Yemeği",
                        status: "Planlandı",
                        isAISuggestion: true,
                        suggestionDetail: suggestionDetail,
                        suggestionType: suggestionType
                    });
                }
                
                if (userData.dinnerTime && userData.cuisines && userData.cuisines.length > 0) {
                    let randomCuisine = userData.cuisines[Math.floor(Math.random() * userData.cuisines.length)];
                    const suggestionType = userData.dinnerPreference || 'home';
                    let suggestionDetail = '';
                    
                    if (suggestionType === 'outside') {
                        suggestionDetail = `PlanIQ, ${randomCuisine} mutfağını sevdiğini fark etti. Akşam yemeği için ${userData.city || 'yakınlardaki'} bölgede popüler bir ${randomCuisine} restoranını keşfetmeye ne dersin?`;
                    } else {
                        suggestionDetail = `PlanIQ, ${randomCuisine} mutfağını sevdiğini fark etti. Akşam yemeğini evde yiyeceğini belirttin, güzel bir ${randomCuisine.toLowerCase()} yemeği yapmaya ne dersin?`;
                    }
                    
                    generatedTasks.push({
                        id: `ai_dinner_${dateKey}`,
                        time: userData.dinnerTime,
                        name: `Akşam Yemeği: ${randomCuisine}`,
                        status: "Planlandı",
                        isAISuggestion: true,
                        suggestionDetail: suggestionDetail,
                        suggestionType: suggestionType
                    });
                }
                
                // Rutin görevler
                generatedTasks.push({
                    id: `routine_wake_${dateKey}`,
                    time: (isWeekend ? userData.weekendWakeTime : userData.weekdayWakeTime) || "08:00",
                    name: "Uyan & Güne Başla",
                    status: "Planlandı",
                    isRoutine: true
                });
                
                generatedTasks.push({
                    id: `routine_sleep_${dateKey}`,
                    time: (isWeekend ? userData.weekendSleepTime : userData.weekdaySleepTime) || "23:00",
                    name: "Uyku Zamanı",
                    status: "Planlandı",
                    isRoutine: true
                });
                
                // Aktivite önerisi
                if (userData.activities && userData.activities.length > 0) {
                    const randomActivity = userData.activities[Math.floor(Math.random() * userData.activities.length)];
                    const dinnerTime = userData.dinnerTime || "19:00";
                    let activityTime = addMinutesToTime(dinnerTime, 90);
                    
                    let suggestionDetail = '';
                    if (randomActivity.includes('Spor')) {
                        activityTime = addMinutesToTime(dinnerTime, -60);
                        suggestionDetail = `PlanIQ, ${randomActivity} yapmayı sevdiğini biliyor. ${activityTime} civarı bunun için iyi bir zaman olabilir!`;
                    } else if (randomActivity.includes('Sinema')) {
                        suggestionDetail = `PlanIQ, sinemaya gitmeyi sevdiğini biliyor! Akşam için film önerisi almak ister misin?`;
                    } else {
                        suggestionDetail = `PlanIQ, ${randomActivity} yapmayı sevdiğini biliyor. Akşam yemeğinden sonra ${activityTime} civarı bunun için iyi bir zaman olabilir!`;
                    }
                    
                    generatedTasks.push({
                        id: `ai_activity_${dateKey}`,
                        time: activityTime,
                        name: `${randomActivity} Zamanı`,
                        status: "Planlandı",
                        isAISuggestion: true,
                        suggestionDetail: suggestionDetail,
                        suggestionType: 'activity'
                    });
                }
                
                return generatedTasks.sort((a, b) => a.time.localeCompare(b.time));
            };
            
            useEffect(() => {
                if (userData && selectedDateKey) {
                    const aiTasks = generateAITasks(userData, selectedDateKey);
                    
                    // Schedule görevlerini ekle (eğer varsa)
                    let scheduleTasks = [];
                    if (userData.scheduleTasks) {
                        const today = new Date(selectedDateKey + 'T00:00:00');
                        const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                        const todayName = dayNames[today.getDay()];
                        
                        scheduleTasks = userData.scheduleTasks.filter(task => 
                            task.dayOfWeek === todayName && task.isRecurring
                        ).map(task => ({
                            ...task,
                            id: `${task.id}-${selectedDateKey}` // Benzersiz ID için tarih ekle
                        }));
                    }
                    
                    // Tüm görevleri birleştir ve sırala
                    const allTasks = [...aiTasks, ...scheduleTasks].sort((a, b) => a.time.localeCompare(b.time));
                    setTasks(allTasks);
                    setIsLoadingTasks(false);
                }
            }, [userData, selectedDateKey]);
            
            const toggleTaskStatus = (taskId, currentStatus) => {
                setTasks(prevTasks => 
                    prevTasks.map(task => 
                        task.id === taskId 
                            ? { ...task, status: currentStatus === 'Tamamlandı' ? 'Planlandı' : 'Tamamlandı' }
                            : task
                    )
                );
            };
            
            const deleteTask = (taskId) => {
                setTasks(prevTasks => prevTasks.filter(task => task.id !== taskId));
            };
            
            const addTask = async () => {
                if (!newTask.time || !newTask.name) return;
                
                const newTaskObj = {
                    id: `manual_${Date.now()}`,
                    time: newTask.time,
                    name: newTask.name,
                    status: 'Planlandı',
                    isAISuggestion: false,
                    isRoutine: false
                };
                
                setTasks(prevTasks => [...prevTasks, newTaskObj].sort((a, b) => a.time.localeCompare(b.time)));
                setNewTask({ time: '', name: '' });
                setIsAddingTask(false);
            };
            
            const getStatusColor = (status) => {
                if (isDark) {
                    const colors = {
                        'Tamamlandı': 'bg-green-900/50 text-green-300 border-green-700',
                        'Planlandı': 'bg-blue-900/50 text-blue-300 border-blue-700',
                        'Beklemede': 'bg-yellow-900/50 text-yellow-300 border-yellow-700'
                    };
                    return colors[status] || 'bg-gray-700 text-gray-300 border-gray-600';
                } else {
                    const colors = {
                        'Tamamlandı': 'bg-green-100 text-green-700 border-green-300',
                        'Planlandı': 'bg-blue-100 text-blue-700 border-blue-300',
                        'Beklemede': 'bg-yellow-100 text-yellow-700 border-yellow-300'
                    };
                    return colors[status] || 'bg-gray-100 text-gray-700 border-gray-300';
                }
            };
            
            const significantTasks = tasks.filter(task => !task.isRoutine);
            const totalSignificantTasks = significantTasks.length;
            const completedSignificantTasks = significantTasks.filter(t => t.status === 'Tamamlandı').length;
            const completionPercentage = Math.round((completedSignificantTasks / (totalSignificantTasks || 1)) * 100);
            
            const fullDateString = formatFullDate(new Date(selectedDateKey + 'T00:00:00'));
            
            return React.createElement('div', {
                className: `${isDark ? 'bg-gray-800' : 'bg-white'} rounded-3xl shadow-2xl overflow-hidden transition-colors duration-300`
            }, [
                // Header
                React.createElement('div', {
                    key: 'header',
                    className: `relative overflow-hidden ${isDark ? 'bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900' : 'bg-gradient-to-br from-purple-600 via-purple-500 to-pink-500'} p-6 sm:p-8 transition-all duration-300`
                }, [
                    React.createElement('div', {
                        key: 'bubbles',
                        className: "absolute inset-0 opacity-10"
                    }, [
                        React.createElement('div', {
                            key: 'bubble1',
                            className: "absolute top-0 left-0 w-64 h-64 bg-white rounded-full blur-3xl transform -translate-x-1/2 -translate-y-1/2"
                        }),
                        React.createElement('div', {
                            key: 'bubble2',
                            className: "absolute bottom-0 right-0 w-64 h-64 bg-white rounded-full blur-3xl transform translate-x-1/2 translate-y-1/2"
                        })
                    ]),
                    React.createElement('div', {
                        key: 'content',
                        className: "relative z-10"
                    }, [
                        React.createElement('div', {
                            key: 'title',
                            className: "flex items-center justify-between mb-4"
                        }, [
                            React.createElement('div', {
                                key: 'date',
                                className: ""
                            }, [
                                React.createElement('h2', {
                                    key: 'day',
                                    className: "text-4xl font-bold text-white"
                                }, day),
                                React.createElement('p', {
                                    key: 'fullDate',
                                    className: "text-white/80 font-medium"
                                }, fullDateString)
                            ]),
                            React.createElement('div', {
                                key: 'counter',
                                className: `flex items-center gap-2 px-4 py-2 ${isDark ? 'bg-white/10' : 'bg-white/20'} backdrop-blur-sm rounded-full`
                            }, [
                                React.createElement('span', {
                                    key: 'icon',
                                    className: "text-white"
                                }, '⏰'),
                                React.createElement('span', {
                                    key: 'count',
                                    className: "text-white font-semibold text-sm"
                                }, `${completedSignificantTasks}/${totalSignificantTasks} Görev`)
                            ])
                        ]),
                        React.createElement('div', {
                            key: 'progress',
                            className: "flex items-center gap-3"
                        }, [
                            React.createElement('span', {
                                key: 'status',
                                className: `px-4 py-1.5 rounded-full text-sm font-semibold ${isDark ? 'bg-gray-700 text-gray-200 border-gray-600' : 'bg-blue-100 text-blue-700 border-blue-300'} shadow-lg border`
                            }, totalSignificantTasks === 0 ? 'Rutin Gün' : totalSignificantTasks <= 2 ? 'Hafif Gün' : totalSignificantTasks <= 4 ? 'Normal Gün' : 'Yoğun Gün'),
                            React.createElement('div', {
                                key: 'bar',
                                className: `flex-1 h-2.5 ${isDark ? 'bg-white/10' : 'bg-white/20'} rounded-full overflow-hidden backdrop-blur-sm`
                            }, React.createElement('div', {
                                className: "h-full bg-white transition-all duration-500 rounded-full",
                                style: { width: `${completionPercentage}%` }
                            })),
                            React.createElement('span', {
                                key: 'percentage',
                                className: "text-white font-bold text-sm w-12 text-right"
                            }, `%${completionPercentage}`)
                        ])
                    ])
                ]),
                
                // Tasks List
                React.createElement('div', {
                    key: 'tasks',
                    className: `p-6 space-y-3 max-h-96 overflow-y-auto ${isDark ? 'bg-gray-800' : ''}`
                }, [
                    isLoadingTasks ? React.createElement('div', {
                        key: 'loading',
                        className: "flex justify-center items-center py-10"
                    }, React.createElement('div', {
                        className: `w-8 h-8 ${isDark ? 'text-purple-300' : 'text-purple-600'} animate-spin`
                    }, '⏳')) : null,
                    
                    !isLoadingTasks && tasks.length === 0 ? React.createElement('p', {
                        key: 'empty',
                        className: `text-center py-10 ${isDark ? 'text-gray-400' : 'text-gray-500'}`
                    }, 'Bu tarih için planlanmış görev yok.') : null,
                    
                    !isLoadingTasks && tasks.map((task) => 
                        React.createElement('div', {
                            key: task.id,
                            className: `p-4 rounded-xl border-2 ${getStatusColor(task.status)} backdrop-blur-sm transition-all hover:scale-102 hover:shadow-md ${task.isAISuggestion ? 'cursor-pointer' : ''}`,
                            onClick: () => task.isAISuggestion && setModalTask(task)
                        }, [
                            React.createElement('div', {
                                key: 'content',
                                className: "flex items-center justify-between"
                            }, [
                                React.createElement('div', {
                                    key: 'left',
                                    className: "flex items-center gap-3 flex-1"
                                }, [
                                    React.createElement('button', {
                                        key: 'toggle',
                                        onClick: (e) => {
                                            e.stopPropagation();
                                            toggleTaskStatus(task.id, task.status);
                                        },
                                        className: "flex-shrink-0 transition-transform hover:scale-110"
                                    }, task.status === 'Tamamlandı' ? '✅' : '⭕'),
                                    React.createElement('div', {
                                        key: 'info',
                                        className: "flex-1 min-w-0"
                                    }, [
                                        React.createElement('div', {
                                            key: 'time',
                                            className: `flex items-center gap-2 mb-1 ${isDark ? 'text-gray-400' : 'text-gray-600'}`
                                        }, [
                                            React.createElement('span', {
                                                key: 'clock',
                                                className: "text-sm"
                                            }, '⏰'),
                                            React.createElement('span', {
                                                key: 'time',
                                                className: "text-sm font-semibold"
                                            }, task.time),
                                            task.isAISuggestion && React.createElement('span', {
                                                key: 'ai',
                                                className: "text-sm"
                                            }, '✨')
                                        ]),
                                        React.createElement('div', {
                                            key: 'name',
                                            className: "flex items-center gap-2"
                                        }, [
                                            task.category === 'schedule' && React.createElement('span', {
                                                key: 'icon',
                                                className: "text-sm"
                                            }, task.type === 'school' ? '🎓' : '💼'),
                                            React.createElement('p', {
                                                key: 'text',
                                                className: `font-medium truncate ${isDark ? 'text-gray-100' : 'text-gray-800'} ${task.status === 'Tamamlandı' ? 'line-through opacity-60' : ''}`
                                            }, task.name),
                                            task.category === 'schedule' && React.createElement('span', {
                                                key: 'badge',
                                                className: `px-2 py-0.5 text-xs rounded-full font-medium ${isDark ? 'bg-blue-900/50 text-blue-300' : 'bg-blue-100 text-blue-800'}`
                                            }, 'Sabit')
                                        ])
                                    ])
                                ]),
                                task.category !== 'schedule' && React.createElement('button', {
                                    key: 'delete',
                                    onClick: (e) => {
                                        e.stopPropagation();
                                        deleteTask(task.id);
                                    },
                                    className: `ml-2 p-2 flex-shrink-0 ${isDark ? 'hover:bg-red-900/50' : 'hover:bg-red-100'} rounded-lg transition-colors`
                                }, '🗑️')
                            ])
                        ])
                    )
                ]),
                
                // Add Task Form
                React.createElement('div', {
                    key: 'addForm',
                    className: `p-6 border-t ${isDark ? 'border-gray-700' : 'border-gray-100'}`
                }, isAddingTask ? [
                    React.createElement('div', {
                        key: 'form',
                        className: "space-y-3"
                    }, [
                        React.createElement('input', {
                            key: 'time',
                            type: "time",
                            value: newTask.time,
                            onChange: (e) => setNewTask({ ...newTask, time: e.target.value }),
                            className: `w-full px-4 py-2 rounded-lg border-2 ${isDark ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-800'}`
                        }),
                        React.createElement('input', {
                            key: 'name',
                            type: "text",
                            placeholder: "Görev adı...",
                            value: newTask.name,
                            onChange: (e) => setNewTask({ ...newTask, name: e.target.value }),
                            className: `w-full px-4 py-2 rounded-lg border-2 ${isDark ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-800'}`
                        }),
                        React.createElement('div', {
                            key: 'buttons',
                            className: "flex gap-2"
                        }, [
                            React.createElement('button', {
                                key: 'cancel',
                                onClick: () => setIsAddingTask(false),
                                className: `w-full py-2 px-4 rounded-lg ${isDark ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-700'} text-sm font-semibold transition-colors`
                            }, 'İptal'),
                            React.createElement('button', {
                                key: 'add',
                                onClick: addTask,
                                className: "w-full py-2 px-4 rounded-lg bg-purple-600 text-white hover:bg-purple-700 text-sm font-semibold transition-colors"
                            }, 'Ekle')
                        ])
                    ])
                ] : React.createElement('button', {
                    key: 'addButton',
                    onClick: () => setIsAddingTask(true),
                    className: `w-full flex items-center justify-center gap-2 py-3 border-2 ${isDark ? 'border-purple-700 text-purple-300 hover:bg-purple-900/50' : 'border-dashed border-purple-300 text-purple-600 hover:bg-purple-50'} rounded-xl transition-all`
                }, ['➕', 'Yeni Görev Ekle'])),
                
                // AI Suggestion Modal
                modalTask && React.createElement('div', {
                    key: 'modal',
                    className: "fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fadeIn",
                    onClick: () => {
                        setModalTask(null);
                        setModalContentStage('initial');
                        setAiSuggestionContent(null);
                    }
                }, React.createElement('div', {
                    className: `rounded-3xl shadow-2xl overflow-hidden ${isDark ? 'bg-gray-800' : 'bg-white'} max-w-lg w-full transform transition-all animate-slideUp`,
                    onClick: (e) => e.stopPropagation()
                }, [
                    React.createElement('div', {
                        key: 'modalHeader',
                        className: `relative overflow-hidden ${isDark ? 'bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900' : 'bg-gradient-to-br from-purple-600 via-purple-500 to-pink-500'} p-6`
                    }, [
                        React.createElement('div', {
                            key: 'title',
                            className: "flex items-center gap-3"
                        }, ['✨', React.createElement('h3', {
                            key: 'text',
                            className: "text-2xl font-bold text-white"
                        }, 'PlanIQ Önerisi')])
                    ]),
                    React.createElement('div', {
                        key: 'modalContent',
                        className: "p-6 space-y-4 min-h-[150px]"
                    }, [
                        React.createElement('p', {
                            key: 'taskName',
                            className: `text-lg font-semibold ${isDark ? 'text-white' : 'text-gray-900'}`
                        }, modalTask.name),
                        
                        // State makinesi ile içerik kontrolü
                        modalContentStage === 'loading' ? React.createElement('div', {
                            key: 'loading',
                            className: "flex items-center justify-center py-8"
                        }, [
                            React.createElement('div', {
                                key: 'spinner',
                                className: "animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"
                            }),
                            React.createElement('span', {
                                key: 'text',
                                className: `ml-3 ${isDark ? 'text-white' : 'text-gray-700'}`
                            }, 'AI önerileri hazırlanıyor...')
                        ]) : modalContentStage === 'recipe' ? React.createElement('div', {
                            key: 'recipeContent',
                            className: "space-y-4"
                        }, [
                            React.createElement('h4', {
                                key: 'title',
                                className: `text-lg font-bold ${isDark ? 'text-white' : 'text-gray-900'} flex items-center gap-2`
                            }, ['🍳', 'Tarif Önerileri']),
                            React.createElement('div', {
                                key: 'suggestions',
                                className: "space-y-4"
                            }, aiSuggestionContent && Array.isArray(aiSuggestionContent) ? aiSuggestionContent.map((recipe, index) => {
                                const [name, description] = recipe.split(':\n');
                                return React.createElement('div', {
                                    key: index,
                                    className: `p-4 rounded-lg ${isDark ? 'bg-gray-700' : 'bg-gray-100'}`
                                }, [
                                    React.createElement('div', {
                                        key: 'header',
                                        className: "flex items-center gap-2 mb-2"
                                    }, [
                                        React.createElement('span', { key: 'icon' }, '👨‍🍳'),
                                        React.createElement('h4', {
                                            key: 'name',
                                            className: `${isDark ? 'text-white' : 'text-gray-800'} font-bold text-lg`
                                        }, name)
                                    ]),
                                    React.createElement('p', {
                                        key: 'description',
                                        className: `${isDark ? 'text-gray-300' : 'text-gray-600'} text-sm leading-relaxed`
                                    }, description)
                                ]);
                            }) : [])
                        ]) : modalContentStage === 'restaurant' ? React.createElement('div', {
                            key: 'restaurantContent',
                            className: "space-y-4"
                        }, [
                            React.createElement('h4', {
                                key: 'title',
                                className: `text-lg font-bold ${isDark ? 'text-white' : 'text-gray-900'} flex items-center gap-2`
                            }, ['🍽️', 'Restoran Önerileri']),
                            React.createElement('div', {
                                key: 'suggestions',
                                className: "space-y-4"
                            }, aiSuggestionContent && Array.isArray(aiSuggestionContent) ? aiSuggestionContent.map((restaurant, index) => {
                                const [name, description] = restaurant.split(':\n');
                                return React.createElement('div', {
                                    key: index,
                                    className: `p-4 rounded-lg ${isDark ? 'bg-gray-700' : 'bg-gray-100'}`
                                }, [
                                    React.createElement('div', {
                                        key: 'header',
                                        className: "flex items-center gap-2 mb-2"
                                    }, [
                                        React.createElement('span', { key: 'icon' }, '📍'),
                                        React.createElement('h4', {
                                            key: 'name',
                                            className: `${isDark ? 'text-white' : 'text-gray-800'} font-bold text-lg`
                                        }, name)
                                    ]),
                                    React.createElement('p', {
                                        key: 'description',
                                        className: `${isDark ? 'text-gray-300' : 'text-gray-600'} text-sm leading-relaxed`
                                    }, description)
                                ]);
                            }) : [])
                        ]) : React.createElement('p', {
                            key: 'suggestion',
                            className: `${isDark ? 'text-gray-300